<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>

    <script src="../dist/library.js"></script>
    <script id="get-user-media">
navigator.getUserMedia = (navigator.getUserMedia ||
                          navigator.webkitGetUserMedia ||
                          navigator.mozGetUserMedia ||
                          navigator.msGetUserMedia);

    initialize();

    function getUserAudio() {
      return new Promise((resolve, reject) => {
        navigator.getUserMedia({ audio: true }, resolve, reject);
      });
    }

    function createLoadAudio(audioContext) {

      function decodeAudioSample(sampleArrayBufferPromise) {
        return Promise.resolve(sampleArrayBufferPromise)
          .then((sampleArrayBuffer)=> {
            return audioContext.decodeAudioData(sampleArrayBuffer);
          });
      }

      function loadSample(wav) {
        return fetch(wav).then((response) => {
          if (!response.ok) {
            throw new Error("file fetch failed");
          }

          return response.arrayBuffer();
        });
      }

      return function(load) {
        return loadSample(load).then(decodeAudioSample);
      }
    }

    function initialize() {
      const audioContext = new AudioContext();
      window.hack_audio = audioContext;
      getUserAudio().then((stream) => {
        return audioContext.createMediaStreamSource(stream);
      })
      .then((source) => {
        const dictionary = {
          'PROJECT': ['P R AA JH EH K T', 'P R OW JH EH K T' ],
          'CUE': ['K Y UW'],
          'MOZILLA': ['M AO Z IH L AH', 'M AO Z IH L ER'],
          'OKAY': ['OW K EY'],
          'GOOGLE': ['G UW G AH L']
        };

        const speechRecognition = new PocketSphinx.PocketSphinx({
          pocketSphinxUrl: '../dist/pocketsphinx.js',
          workerUrl: '../dist/ps-worker.js',
          args: [
            ['-kws_threshold', '2'],
            ['-samprate', '16000'],
          ]
        });

        speechRecognition.initialize()
          .then(() => speechRecognition.addWords(dictionary))
          .then(() => speechRecognition.addKeyword('OKAY GOOGLE'))
          .then(() => speechRecognition.start())
          .then(() => {
            sphinxProcessor.on('data', (buffer) => {
              speechRecognition.process(buffer).then((result) => {
                if (result.hypothesis.length)
                  document.body.innerText = JSON.stringify(result);
              });
            });
          })
          .catch((e) => {
            console.log(e);
          });


        const sphinxProcessor = new PocketSphinx.Audio(audioContext, 16000);

        const decimatedSource = sphinxProcessor.start(source);

        decimatedSource.connect(audioContext.destination);
        source.loop = false;
      }).catch((e) => {
        console.error(e)
      });
    }
    </script>
  </body>
</html>
